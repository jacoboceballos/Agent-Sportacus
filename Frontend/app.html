<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Sportacus - Your Personal Trainer</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .profile-summary { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .profile-item { background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; }
        .profile-item strong { color: #333; }
        .actions { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .actions button { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .actions button:hover { background: #218838; }
        .results { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .workout-plan, .nutrition-plan { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .formatted-output { line-height: 1.8; font-size: 14px; }
        .formatted-output h1, .formatted-output h2, .formatted-output h3 { color: #333; margin: 25px 0 5px 0; }
        .formatted-output h1 { font-size: 18px; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .formatted-output h2 { font-size: 16px; color: #28a745; }
        .formatted-output h3 { font-size: 14px; color: #6c757d; }
        .formatted-output ul, .formatted-output ol { margin: 5px 0 20px 0; padding-left: 20px; }
        .formatted-output li { margin: 5px 0; }
        .formatted-output p { margin: 8px 0; }
        .formatted-output strong { color: #495057; }
        .chat-section { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 20px; }
        .chat-messages { height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 5px; }
        .message.user { background: #e3f2fd; text-align: right; }
        .message.bot { background: #f1f8e9; }
        .message .formatted-output { margin: 5px 0; }
        .chat-input { display: flex; gap: 10px; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .chat-input button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .loading { color: #666; font-style: italic; }
        @media (max-width: 768px) { .results { grid-template-columns: 1fr; } .actions { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üèãÔ∏è Agent Sportacus - Your Personal Trainer</h1>
        </div>
        <div class="user-info">
            <span id="welcomeText">Welcome back!</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="profile-summary">
        <h2 onclick="toggleProfileStats()" style="cursor: pointer; display: flex; align-items: center; gap: 10px;">
            Your Profile <span id="profileToggle">‚ñº</span>
        </h2>
        <div class="profile-grid" id="profileGrid" style="display: none;">
            <div class="loading">Loading your profile...</div>
        </div>
    </div>

    <div class="actions">
        <button onclick="getWorkoutPlan()">Get Personalized Workout</button>
        <button onclick="getNutritionAdvice()">Get Nutrition Advice</button>
        <button onclick="openJournal()" style="background: #17a2b8;">üìù Workout Journal</button>
        <button onclick="editProfile()" style="background: #007bff;">Edit Profile</button>
        <button onclick="clearAll()">Clear All</button>
    </div>

    <div class="results">
        <div class="workout-plan">
            <h3>Your Personalized Workout Plan</h3>
            <div id="workoutResult" class="formatted-output">Click "Get Personalized Workout" to see your custom workout plan based on your profile and history...</div>
        </div>
        <div class="nutrition-plan">
            <h3>Your Nutrition Advice</h3>
            <div id="nutritionResult" class="formatted-output">Click "Get Nutrition Advice" to see personalized nutrition recommendations...</div>
        </div>
    </div>

    <div class="chat-section">
        <h3>Chat with Your Personal Agent Sportacus</h3>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <strong>Agent Sportacus:</strong> <div class="formatted-output">Hi! I'm your personalized Agent Sportacus trainer. I know your fitness profile and history, so I can give you tailored advice. What would you like to work on today?</div>
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Ask your personal trainer anything..." onkeypress="if(event.key==='Enter') sendMessage()" />
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script src="formatter.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000';
        let userProfile = null;

        function getAuthHeaders() {
            const token = localStorage.getItem('fitbot_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        async function loadUserProfile() {
            try {
                const response = await fetch(`${API_BASE}/profile/get`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    userProfile = await response.json();
                    displayProfile(userProfile);
                } else if (response.status === 401) {
                    logout();
                } else {
                    window.location.href = 'onboarding.html';
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        function displayProfile(profile) {
            const preferences = profile.preferences || {};
            const exerciseTypes = preferences.exercise_types || [];
            const equipment = preferences.equipment || [];
            
            const grid = document.getElementById('profileGrid');
            grid.innerHTML = `
                <div class="profile-item">
                    <strong>Basic Info:</strong><br>${profile.age} years, ${profile.weight} lbs, ${profile.height}" tall
                </div>
                <div class="profile-item">
                    <strong>Fitness Level:</strong><br>${profile.fitness_level || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Primary Goal:</strong><br>${profile.primary_goal || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Activity Level:</strong><br>${profile.activity_level || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Workout Frequency:</strong><br>${profile.workout_frequency || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Workout Duration:</strong><br>${profile.workout_duration || 'Not set'}
                </div>
                ${profile.target_weight ? `
                <div class="profile-item">
                    <strong>Target Weight:</strong><br>${profile.target_weight} lbs
                </div>` : ''}
                <div class="profile-item">
                    <strong>Timeline:</strong><br>${profile.timeline || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Motivation:</strong><br>${profile.motivation || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Preferred Time:</strong><br>${profile.preferred_time || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Workout Location:</strong><br>${profile.workout_location || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Sleep:</strong><br>${profile.sleep_hours || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Stress Level:</strong><br>${profile.stress_level || 'Not set'}
                </div>
                ${exerciseTypes.length ? `
                <div class="profile-item">
                    <strong>Exercise Preferences:</strong><br>${exerciseTypes.join(', ')}
                </div>` : ''}
                ${equipment.length ? `
                <div class="profile-item">
                    <strong>Available Equipment:</strong><br>${equipment.join(', ')}
                </div>` : ''}
                ${profile.dietary_restrictions ? `
                <div class="profile-item">
                    <strong>Dietary Restrictions:</strong><br>${profile.dietary_restrictions}
                </div>` : ''}
                ${profile.medical_conditions ? `
                <div class="profile-item">
                    <strong>Medical Conditions:</strong><br>${profile.medical_conditions}
                </div>` : ''}
            `;
        }

        async function callPersonalizedAgent(type, message = '') {
            try {
                const response = await fetch(`${API_BASE}/agent/chat`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ type, message })
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.response;
                } else if (response.status === 401) {
                    logout();
                    return 'Session expired. Please login again.';
                } else {
                    return 'Error getting response. Please try again.';
                }
            } catch (error) {
                return `Error: ${error.message}`;
            }
        }

        async function getWorkoutPlan() {
            document.getElementById('workoutResult').innerHTML = '<div class="loading">Creating your personalized workout plan...</div>';
            const result = await callPersonalizedAgent('workout_plan');
            document.getElementById('workoutResult').innerHTML = formatLLMOutput(result);
        }

        async function getNutritionAdvice() {
            document.getElementById('nutritionResult').innerHTML = '<div class="loading">Preparing your personalized nutrition advice...</div>';
            const result = await callPersonalizedAgent('nutrition_advice');
            document.getElementById('nutritionResult').innerHTML = formatLLMOutput(result);
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const chatMessages = document.getElementById('chatMessages');
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.innerHTML = `<strong>You:</strong> ${message}`;
            chatMessages.appendChild(userMsg);
            
            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Add loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'message bot';
            loadingMsg.innerHTML = '<strong>Agent Sportacus:</strong> <div class="loading">Thinking about your personalized response...</div>';
            chatMessages.appendChild(loadingMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Get bot response
            const response = await callPersonalizedAgent('chat', message);

            // Replace loading with actual response
            loadingMsg.innerHTML = `<strong>Agent Sportacus:</strong> <div class="formatted-output">${formatLLMOutput(response)}</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function editProfile() {
            window.location.href = 'edit-profile.html';
        }
        
        function openJournal() {
            window.location.href = 'journal.html';
        }
        
        function toggleProfileStats() {
            const grid = document.getElementById('profileGrid');
            const toggle = document.getElementById('profileToggle');
            
            if (grid.style.display === 'none') {
                grid.style.display = 'grid';
                toggle.textContent = '‚ñ≤';
            } else {
                grid.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

        function clearAll() {
            document.getElementById('workoutResult').innerHTML = 'Click "Get Personalized Workout" to see your custom workout plan based on your profile and history...';
            document.getElementById('nutritionResult').innerHTML = 'Click "Get Nutrition Advice" to see personalized nutrition recommendations...';
        }

        function logout() {
            localStorage.removeItem('fitbot_token');
            localStorage.removeItem('fitbot_user_id');
            localStorage.clear(); // Clear all localStorage
            sessionStorage.clear(); // Clear all sessionStorage
            window.location.replace('auth.html'); // Use replace to prevent back button issues
        }

        // Check authentication and load profile
        if (!localStorage.getItem('fitbot_token')) {
            window.location.href = 'auth.html';
        } else {
            loadUserProfile();
        }
    </script>
</body>
</html>