<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Sportacus - Edit Profile</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
        .edit-container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #333; margin: 0; }
        .back-btn { background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        .back-btn:hover { background: #545b62; }
        .step { margin-bottom: 30px; }
        .step h3 { color: #007bff; margin-bottom: 15px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .form-group textarea { height: 80px; resize: vertical; }
        .btn { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
        .btn:hover { background: #218838; }
        .error { color: #dc3545; margin-top: 10px; }
        .success { color: #28a745; margin-top: 10px; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div class="edit-container">
        <button class="back-btn" onclick="goBack()">‚Üê Back to Dashboard</button>
        
        <div class="header">
            <h1>üèãÔ∏è Edit Your Profile</h1>
            <p>Update your fitness information</p>
        </div>

        <div id="loadingDiv" class="loading">Loading your current profile...</div>

        <form id="editForm" style="display: none;">
            <div class="step">
                <h3>üìä Basic Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="age">Age:</label>
                        <input type="number" id="age" min="13" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="weight">Weight (lbs):</label>
                        <input type="number" id="weight" min="66" max="660" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="height">Height (inches):</label>
                        <input type="number" id="height" min="39" max="98" required>
                    </div>
                </div>
            </div>

            <div class="step">
                <h3>üéØ Fitness Goals</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="fitness_level">Current Fitness Level:</label>
                        <select id="fitness_level" required>
                            <option value="beginner">Beginner (Just starting)</option>
                            <option value="intermediate">Intermediate (Some experience)</option>
                            <option value="advanced">Advanced (Very experienced)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="primary_goal">Primary Goal:</label>
                        <select id="primary_goal" required>
                            <option value="weight_loss">Weight Loss</option>
                            <option value="muscle_gain">Muscle Gain</option>
                            <option value="general_fitness">General Fitness</option>
                            <option value="strength">Build Strength</option>
                            <option value="endurance">Improve Endurance</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="activity_level">Current Activity Level:</label>
                    <select id="activity_level" required>
                        <option value="sedentary">Sedentary (Little to no exercise)</option>
                        <option value="lightly_active">Lightly Active (Light exercise 1-3 days/week)</option>
                        <option value="moderately_active">Moderately Active (Moderate exercise 3-5 days/week)</option>
                        <option value="very_active">Very Active (Hard exercise 6-7 days/week)</option>
                        <option value="extremely_active">Extremely Active (Very hard exercise, physical job)</option>
                    </select>
                </div>
            </div>

            <div class="step">
                <h3>üí™ Fitness Experience</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workout_frequency">How often do you currently work out?</label>
                        <select id="workout_frequency" required>
                            <option value="never">Never</option>
                            <option value="1-2_times">1-2 times per week</option>
                            <option value="3-4_times">3-4 times per week</option>
                            <option value="5-6_times">5-6 times per week</option>
                            <option value="daily">Daily</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="workout_duration">Preferred workout duration:</label>
                        <select id="workout_duration" required>
                            <option value="15-30_min">15-30 minutes</option>
                            <option value="30-45_min">30-45 minutes</option>
                            <option value="45-60_min">45-60 minutes</option>
                            <option value="60+_min">60+ minutes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>What types of exercise do you enjoy? (Select all that apply)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" id="cardio" value="cardio"> Cardio/Running</label>
                        <label><input type="checkbox" id="strength" value="strength"> Strength Training</label>
                        <label><input type="checkbox" id="yoga" value="yoga"> Yoga/Pilates</label>
                        <label><input type="checkbox" id="sports" value="sports"> Sports</label>
                        <label><input type="checkbox" id="swimming" value="swimming"> Swimming</label>
                        <label><input type="checkbox" id="cycling" value="cycling"> Cycling</label>
                        <label><input type="checkbox" id="dancing" value="dancing"> Dancing</label>
                        <label><input type="checkbox" id="hiking" value="hiking"> Hiking/Outdoor</label>
                    </div>
                </div>
            </div>

            <div class="step">
                <h3>üéØ Specific Goals & Timeline</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="target_weight">Target Weight (lbs, optional):</label>
                        <input type="number" id="target_weight" min="66" max="660" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="timeline">Timeline to reach goal:</label>
                        <select id="timeline" required>
                            <option value="1_month">1 month</option>
                            <option value="3_months">3 months</option>
                            <option value="6_months">6 months</option>
                            <option value="1_year">1 year</option>
                            <option value="long_term">Long-term (1+ years)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="motivation">What motivates you to exercise?</label>
                    <select id="motivation" required>
                        <option value="health">Health & wellness</option>
                        <option value="appearance">Look better/confidence</option>
                        <option value="performance">Athletic performance</option>
                        <option value="stress">Stress relief</option>
                        <option value="energy">More energy</option>
                        <option value="social">Social/fun activity</option>
                    </select>
                </div>
            </div>

            <div class="step">
                <h3>‚è∞ Schedule & Preferences</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="preferred_time">Preferred workout time:</label>
                        <select id="preferred_time" required>
                            <option value="early_morning">Early morning (5-7 AM)</option>
                            <option value="morning">Morning (7-10 AM)</option>
                            <option value="midday">Midday (10 AM-2 PM)</option>
                            <option value="afternoon">Afternoon (2-6 PM)</option>
                            <option value="evening">Evening (6-9 PM)</option>
                            <option value="night">Night (9+ PM)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="workout_location">Preferred workout location:</label>
                        <select id="workout_location" required>
                            <option value="home">Home</option>
                            <option value="gym">Gym</option>
                            <option value="outdoor">Outdoor</option>
                            <option value="mixed">Mixed (home + gym/outdoor)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Available equipment (select all that apply):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" id="no_equipment" value="no_equipment"> No equipment</label>
                        <label><input type="checkbox" id="dumbbells" value="dumbbells"> Dumbbells</label>
                        <label><input type="checkbox" id="resistance_bands" value="resistance_bands"> Resistance bands</label>
                        <label><input type="checkbox" id="yoga_mat" value="yoga_mat"> Yoga mat</label>
                        <label><input type="checkbox" id="full_gym" value="full_gym"> Full gym access</label>
                        <label><input type="checkbox" id="cardio_machine" value="cardio_machine"> Cardio machines</label>
                    </div>
                </div>
            </div>

            <div class="step">
                <h3>üçé Health & Nutrition</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sleep_hours">Average sleep per night:</label>
                        <select id="sleep_hours" required>
                            <option value="less_than_5">Less than 5 hours</option>
                            <option value="5-6_hours">5-6 hours</option>
                            <option value="6-7_hours">6-7 hours</option>
                            <option value="7-8_hours">7-8 hours</option>
                            <option value="8+_hours">8+ hours</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="stress_level">Current stress level:</label>
                        <select id="stress_level" required>
                            <option value="low">Low</option>
                            <option value="moderate">Moderate</option>
                            <option value="high">High</option>
                            <option value="very_high">Very high</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="dietary_restrictions">Dietary Restrictions (optional):</label>
                    <textarea id="dietary_restrictions" placeholder="e.g., vegetarian, gluten-free, allergies..."></textarea>
                </div>
                <div class="form-group">
                    <label for="medical_conditions">Medical Conditions (optional):</label>
                    <textarea id="medical_conditions" placeholder="e.g., diabetes, heart condition, injuries..."></textarea>
                </div>
            </div>

            <button type="submit" class="btn">Save Changes üíæ</button>
        </form>

        <div id="message"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        function getAuthHeaders() {
            const token = localStorage.getItem('fitbot_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function showMessage(text, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="${isError ? 'error' : 'success'}">${text}</div>`;
        }

        async function loadProfile() {
            try {
                const response = await fetch(`${API_BASE}/profile/get`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const profile = await response.json();
                    populateForm(profile);
                    document.getElementById('loadingDiv').style.display = 'none';
                    document.getElementById('editForm').style.display = 'block';
                } else if (response.status === 401) {
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.replace('auth.html');
                } else {
                    showMessage('Failed to load profile', true);
                }
            } catch (error) {
                showMessage('Network error. Please try again.', true);
            }
        }

        function populateForm(profile) {
            document.getElementById('age').value = profile.age || '';
            document.getElementById('weight').value = profile.weight || '';
            document.getElementById('height').value = profile.height || '';
            document.getElementById('fitness_level').value = profile.fitness_level || 'beginner';
            document.getElementById('primary_goal').value = profile.primary_goal || 'general_fitness';
            document.getElementById('activity_level').value = profile.activity_level || 'moderately_active';
            document.getElementById('workout_frequency').value = profile.workout_frequency || 'never';
            document.getElementById('workout_duration').value = profile.workout_duration || '30-45_min';
            document.getElementById('target_weight').value = profile.target_weight || '';
            document.getElementById('timeline').value = profile.timeline || '3_months';
            document.getElementById('motivation').value = profile.motivation || 'health';
            document.getElementById('preferred_time').value = profile.preferred_time || 'evening';
            document.getElementById('workout_location').value = profile.workout_location || 'home';
            document.getElementById('sleep_hours').value = profile.sleep_hours || '7-8_hours';
            document.getElementById('stress_level').value = profile.stress_level || 'moderate';
            document.getElementById('dietary_restrictions').value = profile.dietary_restrictions || '';
            document.getElementById('medical_conditions').value = profile.medical_conditions || '';
            
            // Handle checkboxes
            const preferences = profile.preferences || {};
            const exerciseTypes = preferences.exercise_types || [];
            const equipment = preferences.equipment || [];
            
            ['cardio', 'strength', 'yoga', 'sports', 'swimming', 'cycling', 'dancing', 'hiking'].forEach(type => {
                const checkbox = document.getElementById(type);
                if (checkbox) checkbox.checked = exerciseTypes.includes(type);
            });
            
            ['no_equipment', 'dumbbells', 'resistance_bands', 'yoga_mat', 'full_gym', 'cardio_machine'].forEach(eq => {
                const checkbox = document.getElementById(eq);
                if (checkbox) checkbox.checked = equipment.includes(eq);
            });
        }

        async function handleSubmit(event) {
            event.preventDefault();

            // Collect exercise preferences
            const exerciseTypes = [];
            ['cardio', 'strength', 'yoga', 'sports', 'swimming', 'cycling', 'dancing', 'hiking'].forEach(type => {
                if (document.getElementById(type)?.checked) exerciseTypes.push(type);
            });
            
            // Collect equipment
            const equipment = [];
            ['no_equipment', 'dumbbells', 'resistance_bands', 'yoga_mat', 'full_gym', 'cardio_machine'].forEach(eq => {
                if (document.getElementById(eq)?.checked) equipment.push(eq);
            });

            const profileData = {
                age: parseInt(document.getElementById('age').value),
                weight: parseFloat(document.getElementById('weight').value),
                height: parseInt(document.getElementById('height').value),
                fitness_level: document.getElementById('fitness_level').value,
                primary_goal: document.getElementById('primary_goal').value,
                activity_level: document.getElementById('activity_level').value,
                workout_frequency: document.getElementById('workout_frequency').value,
                workout_duration: document.getElementById('workout_duration').value,
                target_weight: document.getElementById('target_weight').value ? parseFloat(document.getElementById('target_weight').value) : null,
                timeline: document.getElementById('timeline').value,
                motivation: document.getElementById('motivation').value,
                preferred_time: document.getElementById('preferred_time').value,
                workout_location: document.getElementById('workout_location').value,
                sleep_hours: document.getElementById('sleep_hours').value,
                stress_level: document.getElementById('stress_level').value,
                dietary_restrictions: document.getElementById('dietary_restrictions').value,
                medical_conditions: document.getElementById('medical_conditions').value,
                preferences: {
                    exercise_types: exerciseTypes,
                    equipment: equipment
                }
            };

            try {
                const response = await fetch(`${API_BASE}/profile/save`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    showMessage('Profile updated successfully!');
                    setTimeout(() => {
                        window.location.replace('app.html');
                    }, 1500);
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to update profile', true);
                }
            } catch (error) {
                showMessage('Network error. Please try again.', true);
            }
        }

        function goBack() {
            window.location.replace('app.html');
        }

        // Check authentication and load profile
        if (!localStorage.getItem('fitbot_token')) {
            window.location.replace('auth.html');
        } else {
            loadProfile();
        }

        document.getElementById('editForm').addEventListener('submit', handleSubmit);
    </script>
</body>
</html>